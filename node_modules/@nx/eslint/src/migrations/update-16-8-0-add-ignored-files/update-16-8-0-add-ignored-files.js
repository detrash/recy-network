"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = update;
const devkit_1 = require("@nx/devkit");
const executor_options_utils_1 = require("@nx/devkit/src/generators/executor-options-utils");
const eslint_file_1 = require("../../generators/utils/eslint-file");
// Add `ignoredFiles` pattern to projects using vite, esbuild, and rollup.
// This is needed because the @nx/dependency-checks lint rule will complain
// about dependencies used in build config files, even though they are not
// production dependencies.
function update(tree) {
    const projects = (0, devkit_1.getProjects)(tree);
    const addIgnorePattern = (ignorePattern) => (_options, projectName) => {
        const project = projects.get(projectName);
        if (!(0, eslint_file_1.findEslintFile)(tree, project.root) ||
            !(0, eslint_file_1.isEslintConfigSupported)(tree)) {
            return;
        }
        if ((0, eslint_file_1.lintConfigHasOverride)(tree, project.root, (o) => Array.isArray(o.files)
            ? o.files.some((f) => f.match(/\.json$/))
            : !!o.files?.match(/\.json$/), true)) {
            (0, eslint_file_1.updateOverrideInLintConfig)(tree, project.root, (o) => !!o.rules?.['@nx/dependency-checks'], (o) => {
                const value = o.rules['@nx/dependency-checks'];
                let ruleSeverity;
                let ruleOptions;
                if (Array.isArray(value)) {
                    ruleSeverity = value[0];
                    ruleOptions = value[1];
                }
                else {
                    ruleSeverity = value;
                    ruleOptions = {};
                }
                ruleOptions.ignoredFiles = [ignorePattern];
                o.rules['@nx/dependency-checks'] = [ruleSeverity, ruleOptions];
                return o;
            });
        }
    };
    (0, executor_options_utils_1.forEachExecutorOptions)(tree, '@nx/vite:build', addIgnorePattern('{projectRoot}/vite.config.{js,ts,mjs,mts}'));
    (0, executor_options_utils_1.forEachExecutorOptions)(tree, '@nx/vite:test', addIgnorePattern('{projectRoot}/vite.config.{js,ts,mjs,mts}'));
    (0, executor_options_utils_1.forEachExecutorOptions)(tree, '@nx/esbuild:esbuild', addIgnorePattern('{projectRoot}/esbuild.config.{js,ts,mjs,mts}'));
    (0, executor_options_utils_1.forEachExecutorOptions)(tree, '@nx/rollup:rollup', addIgnorePattern('{projectRoot}/rollup.config.{js,ts,mjs,mts}'));
}
